---
import 'flag-icons/css/flag-icons.min.css';
import { t, getLocalePath, locales, type Locale } from '../i18n/utils';

interface Props {
	title: string;
	lang?: Locale;
}

const { title, lang = 'en' } = Astro.props;

const currentPath = Astro.url.pathname;
// Strip the locale prefix to get the base path
const basePath = lang === 'en'
	? currentPath
	: currentPath.replace(`/${lang}`, '') || '/';

const localeToFlag: Record<Locale, string> = {
	en: 'gb',
	no: 'no',
	fr: 'fr',
};
---

<html lang={lang}>
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet" />
		<title>{title}</title>
		<script is:inline>
			(function () {
				const stored = localStorage.getItem('theme');
				if (stored) document.documentElement.setAttribute('data-theme', stored);
			})();
		</script>
	</head>
	<body>
		<nav>
			<div class="nav-links">
				<a href={getLocalePath(lang, '/')}>{t(lang, 'nav.home')}</a>
				<a href={getLocalePath(lang, '/resume')}>{t(lang, 'nav.resume')}</a>
				<a href={getLocalePath(lang, '/about')}>{t(lang, 'nav.about')}</a>
				<a href={getLocalePath(lang, '/styleguide')}>{t(lang, 'nav.styleguide')}</a>
			</div>
			<button class="theme-toggle" type="button" aria-label="Toggle dark mode">
				<svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="4.22" x2="19.78" y2="5.64"/></svg>
				<svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
			</button>
			<div class="lang-switcher">
				{locales.map((locale) => (
					<a
						href={getLocalePath(locale, basePath)}
						class:list={[{ active: locale === lang }]}
						aria-label={t(lang, `lang.${locale}` as any)}
					>
						<span class={`fi fi-${localeToFlag[locale]}`}></span>
					</a>
				))}
			</div>
		</nav>
		<main>
			<slot />
		</main>
		<footer>
			<p>{t(lang, 'footer.copyright')}</p>
		</footer>
	</body>
</html>

<script>
	function updateToggleIcon() {
		const isDark = document.documentElement.getAttribute('data-theme') === 'dark' ||
			(!document.documentElement.getAttribute('data-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
		document.querySelectorAll('.theme-toggle').forEach((btn) => {
			btn.querySelector('.icon-sun')!.setAttribute('style', isDark ? 'display:none' : '');
			btn.querySelector('.icon-moon')!.setAttribute('style', isDark ? '' : 'display:none');
		});
	}

	document.querySelectorAll('.theme-toggle').forEach((btn) => {
		btn.addEventListener('click', () => {
			const current = document.documentElement.getAttribute('data-theme');
			const isDark = current === 'dark' ||
				(!current && window.matchMedia('(prefers-color-scheme: dark)').matches);
			const next = isDark ? 'light' : 'dark';
			document.documentElement.setAttribute('data-theme', next);
			localStorage.setItem('theme', next);
			updateToggleIcon();
		});
	});

	updateToggleIcon();
</script>

<style is:global>
	*, *::before, *::after {
		box-sizing: border-box;
	}
</style>

<style>
	:root {
		--color-heading: #111111;
		--color-text: #444444;
		--color-primary: #09637E;
		--color-secondary: #088395;
		--color-tertiary: #7AB2B2;
		--color-bg: #EBF4F6;
		--color-border: #b8d8dc;
		--color-surface: #d5e8eb;
	}

	@media (prefers-color-scheme: dark) {
		:root:not([data-theme="light"]) {
			--color-heading: #e8e8e8;
			--color-text: #b0b0b0;
			--color-primary: #3db8d9;
			--color-secondary: #2fcbdb;
			--color-tertiary: #5a9494;
			--color-bg: #121212;
			--color-border: #2a3a3d;
			--color-surface: #1e2a2d;
		}
	}

	[data-theme="dark"] {
		--color-heading: #e8e8e8;
		--color-text: #b0b0b0;
		--color-primary: #3db8d9;
		--color-secondary: #2fcbdb;
		--color-tertiary: #5a9494;
		--color-bg: #121212;
		--color-border: #2a3a3d;
		--color-surface: #1e2a2d;
	}

	html {
		font-family: 'Noto Sans', sans-serif;
		color: var(--color-text);
		background: var(--color-bg);
		height: 100%;
		display: flex;
		flex-direction: column;
		transition: color 0.3s ease, background 0.3s ease;
	}

	html *, html *::before, html *::after {
		transition: color 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
	}

	body {
		margin: 0 auto;
		max-width: 720px;
		padding: 1rem;
		min-height: 100%;
		display: flex;
		flex-direction: column;
	}

	nav {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1rem 0;
		border-bottom: 1px solid var(--color-border);
		margin-bottom: 2rem;
	}

	.nav-links {
		display: flex;
		gap: 1.5rem;
	}

	nav a {
		color: var(--color-heading);
		text-decoration: none;
	}

	nav a:hover {
		text-decoration: underline;
	}

	.theme-toggle {
		background: none;
		border: none;
		cursor: pointer;
		color: var(--color-heading);
		padding: 0.25rem;
		display: flex;
		align-items: center;
		margin-left: auto;
	}

	.theme-toggle:hover {
		color: var(--color-primary);
	}

	.lang-switcher {
		display: flex;
		gap: 0.5rem;
		margin-left: 0.75rem;
	}

	.lang-switcher a {
		display: flex;
		opacity: 0.5;
		transition: opacity 0.15s;
	}

	.lang-switcher a:hover {
		opacity: 0.8;
		text-decoration: none;
	}

	.lang-switcher a.active {
		opacity: 1;
	}

	main {
		flex: 1;
	}

	footer {
		margin-top: 3rem;
		padding: 1rem 0;
		border-top: 1px solid var(--color-border);
		color: var(--color-text);
		font-size: 0.875rem;
	}
</style>
